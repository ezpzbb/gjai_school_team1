# 사고 알림 테스트 가이드

## 사전 준비

### 1. 즐겨찾기 CCTV 확인
```sql
-- 테스트 사용자의 즐겨찾기 CCTV 확인
SELECT 
    u.username,
    u.user_id,
    f.cctv_id,
    cctv.location,
    cctv.latitude,
    cctv.longitude
FROM Favorite f
INNER JOIN User u ON f.user_id = u.user_id
INNER JOIN CCTV cctv ON f.cctv_id = cctv.cctv_id
WHERE u.username = 'test1';
```

### 2. CCTV 좌표 확인
```sql
-- 특정 CCTV의 좌표 확인
SELECT 
    cctv_id,
    location,
    latitude,
    longitude
FROM CCTV
WHERE cctv_id = 149442;  -- 테스트할 CCTV ID
```

---

## 테스트 방법 1: 테스트용 사고 이벤트 생성 (권장)

### Postman 요청

**URL:** `POST http://localhost:3002/api/notifications/test/accident`

**Headers:**
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```

**Body (JSON):**
```json
{
  "cctv_id": 149442,
  "distance_meters": 150
}
```

**옵션:**
- `cctv_id` (필수): 즐겨찾기한 CCTV ID
- `distance_meters` (선택): CCTV로부터의 거리 (미터). 기본값: 100m
- `latitude` (선택): 사고 이벤트 위도 (지정하지 않으면 CCTV에서 distance_meters만큼 떨어진 위치 자동 계산)
- `longitude` (선택): 사고 이벤트 경도

**예시 1: 기본 사용 (100m 거리)**
```json
{
  "cctv_id": 149442
}
```

**예시 2: 200m 거리 지정**
```json
{
  "cctv_id": 149442,
  "distance_meters": 200
}
```

**예시 3: 특정 위치 지정**
```json
{
  "cctv_id": 149442,
  "latitude": 35.123456,
  "longitude": 126.789012,
  "distance_meters": 150
}
```

### 응답 예시
```json
{
  "success": true,
  "message": "사고 알림 테스트가 완료되었습니다.",
  "data": {
    "test_event": {
      "event_id": "TEST_ACCIDENT_1234567890",
      "event_type": "교통사고",
      "location": "테스트 위치",
      "cctv_latitude": 35.123456,
      "cctv_longitude": 126.789012,
      "event_latitude": 35.123457,
      "event_longitude": 126.789013,
      "distance_meters": 150
    }
  }
}
```

---

## 테스트 방법 2: 실제 경찰청 이벤트 업데이트 트리거

### Postman 요청

**URL:** `POST http://localhost:3002/api/notifications/test/accident/update`

**Headers:**
```
Authorization: Bearer {JWT_TOKEN}
```

**Body:** 없음

이 방법은 실제 경찰청 API에서 최신 이벤트를 가져와서 사고 알림을 발송합니다.

---

## 테스트 후 확인

### 1. 알림 발송 확인 (SQL)
```sql
-- 사고 알림 이력 확인
SELECT 
    n.notification_id,
    n.notification_type,
    n.event_id,
    u.username,
    u.user_id,
    n.cctv_id,
    cctv.location,
    n.distance_meters,
    n.sent_at,
    n.status
FROM notification n
INNER JOIN User u ON n.user_id = u.user_id
INNER JOIN CCTV cctv ON n.cctv_id = cctv.cctv_id
WHERE n.notification_type = 'accident'
    AND u.username = 'test1'
ORDER BY n.sent_at DESC
LIMIT 10;
```

### 2. 알림 발송 대상 확인
```sql
-- 특정 사고 이벤트에 대한 알림 발송 대상 확인
SELECT DISTINCT
    u.username,
    u.user_id,
    f.cctv_id,
    cctv.location,
    cctv.latitude as cctv_lat,
    cctv.longitude as cctv_lon,
    n.event_id,
    n.distance_meters,
    CASE 
        WHEN n.notification_id IS NULL THEN '✅ 알림 발송 가능'
        ELSE '❌ 이미 알림 발송됨'
    END as notification_status
FROM Favorite f
INNER JOIN User u ON f.user_id = u.user_id
INNER JOIN CCTV cctv ON f.cctv_id = cctv.cctv_id
LEFT JOIN notification n 
    ON n.notification_type = 'accident'
    AND n.user_id = f.user_id
    AND n.cctv_id = f.cctv_id
    AND n.event_id = 'TEST_ACCIDENT_1234567890'  -- 테스트 이벤트 ID
WHERE u.username = 'test1'
    AND f.cctv_id = 149442;
```

### 3. 프론트엔드 확인
- Socket.IO 연결 확인
- 알림 토스트 메시지 확인
- 알림 드롭다운에 사고 알림 표시 확인

---

## 테스트 시나리오

### 시나리오 1: 200m 이내 사고 알림 (정상)
1. 즐겨찾기 CCTV 추가 (예: cctv_id = 149442)
2. Postman으로 테스트 요청:
   ```json
   {
     "cctv_id": 149442,
     "distance_meters": 150
   }
   ```
3. 알림 발송 확인 (SQL 쿼리 실행)
4. 프론트엔드에서 알림 수신 확인

### 시나리오 2: 200m 초과 사고 (알림 없음)
1. Postman으로 테스트 요청:
   ```json
   {
     "cctv_id": 149442,
     "distance_meters": 250
   }
   ```
2. 알림이 발송되지 않아야 함

### 시나리오 3: 중복 알림 방지
1. 동일한 이벤트로 두 번 요청
2. 첫 번째 요청: 알림 발송됨
3. 두 번째 요청: 중복으로 인해 알림 발송 안 됨

### 시나리오 4: 여러 CCTV에 대한 알림
1. 여러 CCTV를 즐겨찾기에 추가
2. 각 CCTV 근처에 사고 이벤트 생성
3. 모든 CCTV에 대해 알림이 발송되는지 확인

---

## 문제 해결

### 알림이 발송되지 않는 경우

1. **즐겨찾기 CCTV 확인**
   ```sql
   SELECT * FROM Favorite WHERE user_id = {user_id};
   ```

2. **거리 확인**
   - distance_meters가 200 이하인지 확인
   - CCTV와 사고 이벤트 간 실제 거리 확인

3. **Socket.IO 연결 확인**
   - 프론트엔드에서 Socket 연결 상태 확인
   - 브라우저 콘솔에서 `accident-alert` 이벤트 수신 확인

4. **서버 로그 확인**
   - 백엔드 콘솔에서 사고 알림 관련 로그 확인
   - 에러 메시지 확인

### 중복 알림이 발생하는 경우

1. **알림 이력 확인**
   ```sql
   SELECT * FROM notification 
   WHERE notification_type = 'accident' 
     AND event_id = '{event_id}'
     AND user_id = {user_id}
     AND cctv_id = {cctv_id};
   ```

2. **UNIQUE KEY 확인**
   - 테이블의 UNIQUE KEY가 올바르게 설정되었는지 확인

---

## 참고사항

- 테스트용 이벤트 ID는 `TEST_ACCIDENT_` 접두사를 사용합니다
- 실제 경찰청 API 이벤트와 구분하기 위해 테스트 이벤트는 별도로 관리됩니다
- 테스트 후 테스트 이벤트는 자동으로 정리되지 않으므로, 필요시 수동으로 삭제하세요

