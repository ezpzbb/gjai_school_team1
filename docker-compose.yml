services:
  # 백엔드 서비스
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vehicle-monitoring-backend
    ports:
      - "${BACKEND_PORT:-3002}:3002"
    environment:
      # 데이터베이스 설정
      DB_HOST: ${DB_HOST:-localhost}
      DB_PORT: ${DB_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME:-your_database}
      # 서버 설정
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3002}
      HOST: 0.0.0.0
      # CORS 설정 (다중 origin 지원)
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
      CORS_CREDENTIALS: ${CORS_CREDENTIALS:-true}
      # JWT 설정
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      # CCTV API 설정 (경찰청 UTIC API)
      CCTV_KEY: ${CCTV_KEY}
      CCTV_API_KEY: ${CCTV_API_KEY}
      NODE_EXTRA_CA_CERTS: ${NODE_EXTRA_CA_CERTS}
      UTIC_CA_PATH: ${NODE_EXTRA_CA_CERTS}
      # 알림 설정
      CONGESTION_THRESHOLD: ${CONGESTION_THRESHOLD:-70}
      ACCIDENT_NOTIFICATION_MAX_DISTANCE: ${ACCIDENT_NOTIFICATION_MAX_DISTANCE:-200}
      # 기타 환경 변수
      DEBUG: ${DEBUG:-false}
    volumes:
      # 업로드 파일 영구 저장 (필요한 경우)
      - ./backend/Uploads:/app/Uploads
      # 인증서 파일 마운트 (경찰청 UTIC API용)
      - ./backend/certs:/app/certs:ro
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # 프론트엔드 서비스
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # 빌드 시 환경 변수 주입 (VITE_ 접두사가 있는 변수들)
        VITE_API_URL: ${VITE_API_URL:-http://localhost:3002}
        VITE_SOCKET_URL: ${VITE_SOCKET_URL:-http://localhost:3002}
        VITE_KAKAO_API_KEY: ${VITE_KAKAO_API_KEY}
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/api}
        VITE_WS_URL: ${VITE_WS_URL:-ws://localhost:5000}
        VITE_CAMERA_STREAM_URL: ${VITE_CAMERA_STREAM_URL:-/stream}
    container_name: vehicle-monitoring-frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

